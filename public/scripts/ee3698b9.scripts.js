"use strict";angular.module("pboardApp",["ngCookies","ngResource","ngSanitize","ngRoute","angularFileUpload","btford.socket-io"]).config(["$routeProvider","$locationProvider","$httpProvider","$logProvider",function(a,b,c,d){a.when("/",{templateUrl:"partials/main",controller:"MainCtrl"}).when("/boards",{templateUrl:"partials/boards",controller:"BoardsCtrl",authenticate:!0}).when("/boards/:id",{templateUrl:"partials/board-viewing",controller:"BoardViewingCtrl",authenticate:!0}).when("/boards/:id/post",{templateUrl:"partials/post",controller:"PostCtrl",authenticate:!0}).when("/boards/:id/settings",{templateUrl:"partials/settings",controller:"SettingsCtrl",authenticate:!0}).otherwise({redirectTo:"/"}),b.html5Mode(!0),c.defaults.useXDomain=!0,delete c.defaults.headers.common["X-Requested-With"],c.interceptors.push(["$q","$location",function(a,b){return{responseError:function(c){return 401===c.status?(b.path("/login"),a.reject(c)):a.reject(c)}}}]),d.debugEnabled(!0)}]).run(["$rootScope","$location","Auth",function(a,b,c){a.$on("$routeChangeStart",function(a,d){d.authenticate&&!c.isLoggedIn()&&(console.log("auth deny"),b.path("/"))})}]).factory("socket",["socketFactory",function(a){return a()}]),angular.module("pboardApp").controller("MainCtrl",["$scope","$location","$http","Auth",function(a,b,c,d){d.isLoggedIn()&&b.path("/boards")}]),angular.module("pboardApp").controller("BoardsCtrl",["$scope","$http","Board","socket","$location",function(a,b,c,d,e){a.boards=c.mine(),a.joinableBoards=c.joinable(),d.on("refreshJoinableBoards",function(){a.joinableBoards=c.joinable()}),a.createBoard=function(){var b=c.create({name:a.newBoardName});a.newBoardName="",a.boards.push(b)},a.goToBoard=function(a){e.path("/boards/"+a._id+"/post")},a.downloadBoard=function(a){b.get("/api/boards/"+a+"/download",function(a){console.log(a)})}}]),angular.module("pboardApp").controller("BoardViewingCtrl",["$scope","$routeParams","$interval","Board","$rootScope","socket","preloader","$filter",function(a,b,c,d,e,f,g,h){a.slideshowSpeed=3e3,a.newPosts=[],a.slideshowIndex=0,a.isLoading=!0,a.board=d.get({id:b.id},function(){a.imageLocations=a.board.posts.map(function(a){return h("publicImageUrl")(a)}),g.preloadImages(a.imageLocations),a.resumeNormalSlideshow()}),f.emit("joinBoard",b.id),f.on("newPost",function(b){console.log("newPost"),a.addNewPostToQueue(b)}),a.addNewPostToQueue=function(b){g.preloadImages([h("publicImageUrl")(b)]).then(function(){function d(){a.newPosts.length>0?(a.currentPost=a.newPosts.shift(),a.board.posts.push(a.currentPost)):(c.cancel(a.newQueueInterval),a.resumeNormalSlideshow())}a.newPosts.push(b),c.cancel(a.slideshowInterval),a.newQueueInterval=c(d,a.slideshowSpeed),d()})},a.resumeNormalSlideshow=function(){a.currentPost=a.board.posts[a.slideshowIndex],a.isLoading=!1,a.slideshowInterval=c(function(){a.currentPost=a.board.posts[a.slideshowIndex],a.slideshowIndex<a.board.posts.length-1?a.slideshowIndex++:a.slideshowIndex=0},a.slideshowSpeed)},a.$on("$destroy",function(){f.emit("leaveBoard",b.id)})}]),angular.module("pboardApp").controller("PostCtrl",["$scope","$routeParams","$route","Board","S3",function(a,b,c,d,e){a.tookPhoto=!1,a.uploadPost=function(){var f=$("#pictureInput")[0].files[0];a.resizeImage(f,function(f){e.uploadImage(f,b.id,function(e){d.addPost({id:b.id},{s3Key:e,quote:a.quote}),c.reload()})})},a.openCamera=function(){$("#pictureInput").click()},a.photoTaken=function(b){a.$apply(function(){a.localPhotoSrc=b})},a.resizeImage=function(a,b){function c(a){for(var b=atob(a.split(",")[1]),c=[],d=0;d<b.length;d++)c.push(b.charCodeAt(d));return new Blob([new Uint8Array(c)],{type:"image/jpeg"})}var d=document.createElement("img"),e=document.createElement("canvas"),f=new FileReader;f.readAsDataURL(a),f.onload=function(a){d.src=a.target.result},d.onload=function(){var f=e.getContext("2d");f.drawImage(d,0,0);var g=1920,h=1080,i=d.width,j=d.height;i>j?i>g&&(j*=g/i,i=g):j>h&&(i*=h/j,j=h),e.width=i,e.height=j,f.drawImage(d,0,0,i,j);var k=e.toDataURL("image/jpeg",.8),l=c(k);l.name=a.name,b(l)}}}]),angular.module("pboardApp").controller("SettingsCtrl",["$scope","$http","Board","socket","$location",function(a,b,c,d,e){a.boards=c.mine(),a.joinableBoards=c.joinable(),d.on("refreshJoinableBoards",function(){a.joinableBoards=c.joinable()}),a.createBoard=function(){var b=c.create({name:a.newBoardName});a.newBoardName="",a.boards.push(b)},a.goToBoard=function(a){e.path("/boards/"+a._id+"/post")}}]),angular.module("pboardApp").controller("NavbarCtrl",["$scope","Auth","$location",function(a,b,c){a.logout=function(){b.logout().then(function(){c.path("/")})}}]),angular.module("pboardApp").factory("Auth",["$location","$rootScope","Session","User","$cookieStore",function(a,b,c,d,e){return b.currentUser=e.get("user")||null,e.remove("user"),{login:function(b,c){var d=c||angular.noop;a.url("/auth/facebook"),d()},logout:function(a){var d=a||angular.noop;return c.delete(function(){return b.currentUser=null,d()},function(a){return d(a)}).$promise},createUser:function(a,c){var e=c||angular.noop;return d.save(a,function(a){return b.currentUser=a,e(a)},function(a){return e(a)}).$promise},changePassword:function(a,b,c){var e=c||angular.noop;return d.update({oldPassword:a,newPassword:b},function(a){return e(a)},function(a){return e(a)}).$promise},currentUser:function(){return d.get()},isLoggedIn:function(){var a=b.currentUser;return!!a}}}]),angular.module("pboardApp").factory("Session",["$resource",function(a){return a("/api/session/")}]),angular.module("pboardApp").factory("User",["$resource",function(a){return a("/api/users/:id",{id:"@id"},{get:{method:"GET",params:{id:"me"}}})}]),angular.module("pboardApp").factory("Board",["$resource",function(a){var b=function(a){var b=angular.fromJson(a);return b.forEach(function(a,c){var d=[];a.posts.forEach(function(a){d.indexOf(a.creator)&&d.push(a.creator)}),b[c].nbContribs=d.length}),b};return a("/api/boards/:id",{id:"@id"},{get:{method:"GET"},mine:{method:"GET",params:{id:"mine"},isArray:!0,transformResponse:b},joinable:{method:"GET",params:{id:"joinable"},isArray:!0,transformResponse:b},create:{method:"POST"},addPost:{method:"PUT"}})}]),angular.module("pboardApp").factory("S3",["$http","$upload",function(a,b){var c=function(b,c,d){a.get("/api/s3Policy?mimeType="+b.type+"&boardId="+c).success(function(a){d(a)})};return{uploadImage:function(a,d,e){c(a,d,function(c){var f=d+"/"+Math.round(1e6*Math.random())+"$"+a.name.replace(" ","-");console.log(f),b.upload({url:"https://partyboard.s3.amazonaws.com/",method:"POST",data:{key:f,acl:"public-read","Content-Type":a.type,AWSAccessKeyId:c.AWSAccessKeyId,success_action_status:"201",Policy:c.s3Policy,Signature:c.s3Signature},file:a}).then(function(){e(f)})})}}}]),angular.module("pboardApp").factory("preloader",["$q","$rootScope",function(a,b){function c(b){this.imageLocations=b,this.imageCount=this.imageLocations.length,this.loadCount=0,this.errorCount=0,this.states={PENDING:1,LOADING:2,RESOLVED:3,REJECTED:4},this.state=this.states.PENDING,this.deferred=a.defer(),this.promise=this.deferred.promise}return c.preloadImages=function(a){var b=new c(a);return b.load()},c.prototype={constructor:c,isInitiated:function(){return this.state!==this.states.PENDING},isRejected:function(){return this.state===this.states.REJECTED},isResolved:function(){return this.state===this.states.RESOLVED},load:function(){if(this.isInitiated())return this.promise;this.state=this.states.LOADING;for(var a=0;a<this.imageCount;a++)this.loadImageLocation(this.imageLocations[a]);return this.promise},handleImageError:function(a){this.errorCount++,this.isRejected()||(this.state=this.states.REJECTED,this.deferred.reject(a))},handleImageLoad:function(a){this.loadCount++,this.isRejected()||(this.deferred.notify({percent:Math.ceil(this.loadCount/this.imageCount*100),imageLocation:a}),this.loadCount===this.imageCount&&(this.state=this.states.RESOLVED,this.deferred.resolve(this.imageLocations)))},loadImageLocation:function(a){var c=this,d=$(new Image).load(function(a){b.$apply(function(){c.handleImageLoad(a.target.src),c=d=a=null})}).error(function(a){b.$apply(function(){c.handleImageError(a.target.src),c=d=a=null})}).prop("src",a)}},c}]),angular.module("pboardApp").filter("publicImageUrl",function(){return function(a){return"/api/posts/"+a._id+"/image"}}).filter("profilePicUrl",function(){return function(a){return"/api/users/"+a._id+"/picture"}}),angular.module("pboardApp").directive("bgImg",function(){return function(a,b,c){c.$observe("bgImg",function(a){b.css({"background-image":"url("+a+")"})})}}),angular.module("pboardApp").directive("notifyOnChange",function(){return{restrict:"A",link:function(a,b){b.change(function(){var c=new FileReader;c.onload=function(b){a.photoTaken(b.target.result)},c.readAsDataURL(b[0].files[0])})}}});